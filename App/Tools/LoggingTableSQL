<?php
// Extracted from App/Tools/build for reuse in tests and build

function getLoggingTableSQL($dbType) {
    switch (strtolower($dbType)) {
        case 'mysql':
            return "
CREATE TABLE IF NOT EXISTS __LOG_ACTIVITY (
  id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
  date DATETIME NOT NULL,
  user VARCHAR(255) DEFAULT NULL,
  method VARCHAR(64) DEFAULT NULL,
  status_code INT DEFAULT 200,
  response_time INT DEFAULT NULL,
  ip_address VARCHAR(45) DEFAULT NULL,
  user_agent TEXT DEFAULT NULL,
  request_uri TEXT DEFAULT NULL,
  trace_id VARCHAR(64) DEFAULT NULL
);

CREATE TABLE IF NOT EXISTS __LOG_ACTIVITY_OPTIONS (
  id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
  id_log_activity INT NOT NULL,
  subOption VARCHAR(255) NOT NULL,
  value VARCHAR(255) NOT NULL,
  KEY id_log_activity (id_log_activity),
  FOREIGN KEY (id_log_activity) REFERENCES __LOG_ACTIVITY(id)
);

CREATE TABLE IF NOT EXISTS __LOG_DATA (
  id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
  id_log_activity INT NOT NULL,
  `table` VARCHAR(255) NOT NULL,
  pk VARCHAR(255) NULL,
  method VARCHAR(10) NULL,
  field VARCHAR(255) NOT NULL,
  dataBefore VARCHAR(255) NULL,
  dataAfter VARCHAR(255) NULL,
  KEY id_log_activity (id_log_activity),
  FOREIGN KEY (id_log_activity) REFERENCES __LOG_ACTIVITY(id)
);

CREATE TABLE IF NOT EXISTS __LOG_ERRORS (
  id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
  error_message TEXT NOT NULL,
  error_code VARCHAR(50) NOT NULL,
  http_status INT NOT NULL,
  severity ENUM('DEBUG','INFO','WARNING','ERROR','CRITICAL') NOT NULL DEFAULT 'ERROR',
  context VARCHAR(100) NOT NULL DEFAULT 'API',
  file_path VARCHAR(500) DEFAULT NULL,
  line_number INT DEFAULT NULL,
  stack_trace LONGTEXT DEFAULT NULL,
  context_data LONGTEXT DEFAULT NULL,
  user_agent VARCHAR(500) DEFAULT NULL,
  ip_address VARCHAR(45) DEFAULT NULL,
  request_uri VARCHAR(500) DEFAULT NULL,
  request_method VARCHAR(10) DEFAULT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  KEY idx_error_code (error_code),
  KEY idx_severity (severity),
  KEY idx_context (context),
  KEY idx_created_at (created_at)
);
";
        case 'sqlite':
            return "
PRAGMA foreign_keys = ON;

CREATE TABLE IF NOT EXISTS __LOG_ACTIVITY (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  date TEXT NOT NULL,
  user TEXT,
  method TEXT,
  status_code INTEGER DEFAULT 200,
  response_time INTEGER,
  ip_address TEXT,
  user_agent TEXT,
  request_uri TEXT,
  trace_id TEXT
);

CREATE TABLE IF NOT EXISTS __LOG_ACTIVITY_OPTIONS (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  id_log_activity INTEGER NOT NULL,
  subOption TEXT NOT NULL,
  value TEXT NOT NULL,
  FOREIGN KEY (id_log_activity) REFERENCES __LOG_ACTIVITY(id)
);

CREATE TABLE IF NOT EXISTS __LOG_DATA (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  id_log_activity INTEGER NOT NULL,
  `table` TEXT NOT NULL,
  pk TEXT,
  method TEXT,
  field TEXT NOT NULL,
  dataBefore TEXT,
  dataAfter TEXT,
  FOREIGN KEY (id_log_activity) REFERENCES __LOG_ACTIVITY(id)
);

CREATE TABLE IF NOT EXISTS __LOG_ERRORS (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  error_message TEXT NOT NULL,
  error_code TEXT NOT NULL,
  http_status INTEGER NOT NULL,
  severity TEXT DEFAULT 'ERROR',
  context TEXT DEFAULT 'API',
  file_path TEXT,
  line_number INTEGER,
  stack_trace TEXT,
  context_data TEXT,
  user_agent TEXT,
  ip_address TEXT,
  request_uri TEXT,
  request_method TEXT,
  created_at TEXT DEFAULT (datetime('now'))
);
";
        case 'mssql':
        case 'sqlsrv':
            return "
CREATE TABLE __LOG_ACTIVITY (
  id INT IDENTITY(1,1) PRIMARY KEY,
  date DATETIME NOT NULL,
  [user] NVARCHAR(255) NULL,
  method NVARCHAR(64) NULL,
  status_code INT DEFAULT 200,
  response_time INT NULL,
  ip_address NVARCHAR(45) NULL,
  user_agent NVARCHAR(MAX) NULL,
  request_uri NVARCHAR(MAX) NULL,
  trace_id NVARCHAR(64) NULL
);

CREATE TABLE __LOG_ACTIVITY_OPTIONS (
  id INT IDENTITY(1,1) PRIMARY KEY,
  id_log_activity INT NOT NULL,
  subOption NVARCHAR(255) NOT NULL,
  value NVARCHAR(255) NOT NULL,
  FOREIGN KEY (id_log_activity) REFERENCES __LOG_ACTIVITY(id)
);

CREATE TABLE __LOG_DATA (
  id INT IDENTITY(1,1) PRIMARY KEY,
  id_log_activity INT NOT NULL,
  [table] NVARCHAR(255) NOT NULL,
  pk NVARCHAR(255) NULL,
  method NVARCHAR(10) NULL,
  field NVARCHAR(255) NOT NULL,
  dataBefore NVARCHAR(255) NULL,
  dataAfter NVARCHAR(255) NULL,
  FOREIGN KEY (id_log_activity) REFERENCES __LOG_ACTIVITY(id)
);

CREATE TABLE __LOG_ERRORS (
  id INT IDENTITY(1,1) PRIMARY KEY,
  error_message NVARCHAR(MAX) NOT NULL,
  error_code NVARCHAR(50) NOT NULL,
  http_status INT NOT NULL,
  severity NVARCHAR(20) DEFAULT 'ERROR',
  context NVARCHAR(100) DEFAULT 'API',
  file_path NVARCHAR(500) NULL,
  line_number INT NULL,
  stack_trace NVARCHAR(MAX) NULL,
  context_data NVARCHAR(MAX) NULL,
  user_agent NVARCHAR(500) NULL,
  ip_address NVARCHAR(45) NULL,
  request_uri NVARCHAR(500) NULL,
  request_method NVARCHAR(10) NULL,
  created_at DATETIME DEFAULT GETDATE()
);
";
        default:
            throw new Exception("Unsupported DB type: $dbType");
    }
} 